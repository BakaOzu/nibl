// Generated by CoffeeScript 1.7.1
(function() {
  'use strict';
  angular.module('niblApp').controller('sidebarCtrl', function($scope, taskService, toaster) {
    var IsEqualToOrigin, alertIfhasUnsavedChanges;
    IsEqualToOrigin = function(task) {
      var origin;
      origin = _.find($scope.tasks, {
        url: task.url
      });
      return angular.equals($scope.selectedTask, origin);
    };
    alertIfhasUnsavedChanges = function() {
      var discardedData, text;
      if (($scope.sidebarMode === 'taskCreation' && $scope.selectedTask !== {}) || ($scope.sidebarMode === 'taskEdition' && !IsEqualToOrigin($scope.selectedTask))) {
        discardedData = {
          mode: $scope.sidebarMode,
          task: $scope.selectedTask
        };
        if ($scope.sidebarMode === 'taskCreation') {
          text = 'Создание задачи прервано, нажмите, чтобы вернуться.';
        } else {
          text = 'Создание задачи прервано, нажмите, чтобы вернуться.';
        }
        return toaster.pop('warning', text, null, null, null, function() {
          $scope.selectedTask = discardedData.task;
          $scope.sidebarMode = discardedData.mode;
          return discardedData = {};
        });
      }
    };
    $scope.openNewsView = function() {
      alertIfhasUnsavedChanges();
      $scope.sidebarMode = 'news';
      return $scope.selectedTask = {};
    };
    $scope.openDetailsView = function(task) {
      if (!task.isSame($scope.selectedTask)) {
        alertIfhasUnsavedChanges();
        $scope.sidebarMode = 'taskDetail';
        return $scope.selectedTask = task;
      }
    };
    $scope.openCreationView = function() {
      alertIfhasUnsavedChanges();
      $scope.selectedTask = {};
      return $scope.sidebarMode = 'taskCreation';
    };
    $scope.openEditionView = function(task) {
      alertIfhasUnsavedChanges();
      $scope.selectedTask = task.clone();
      return $scope.sidebarMode = 'taskEdition';
    };
    $scope.save = function(task) {
      if ($scope.sidebarMode === 'taskCreation') {
        return taskService.post(task).then(function(refinedTask) {
          $scope.selectedTask = refinedTask;
          $scope.tasks.push(refinedTask);
          return $scope.sidebarMode = 'taskDetail';
        }, function(errors) {
          return toaster.pop('error', errors.statusText);
        });
      } else if (!IsEqualToOrigin(task)) {
        return task.put().then(function(refinedTask) {
          var taskIndex;
          taskIndex = _.findIndex($scope.tasks, {
            url: task.url
          });
          $scope.tasks[taskIndex] = refinedTask;
          return $scope.sidebarMode = 'taskDetail';
        }, function(errors) {
          return toaster.pop('error', errors.statusText);
        });
      }
    };
    $scope["delete"] = function(task) {
      return task.remove().then(function() {
        _.pull($scope.tasks, task);
        $scope.openNewsView();
        task = $scope.discardedTask;
        return toaster.pop('error', 'Task deleted');
      }, function(errors) {
        return toaster.pop('error', errors.statusText);
      });
    };
    return $scope.openNewsView();
  });

}).call(this);
